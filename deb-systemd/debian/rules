#!/usr/bin/make -ef

include /usr/share/dpkg/architecture.mk

DPKG_COREDNS_VERSION := $(shell curl -s https://api.github.com/repos/coredns/coredns/releases/latest  | jq -r '.tag_name[1:length]')
# Github is ratelimiting this API pretty aggresively, error when not set.
ifeq ($(DPKG_COREDNS_VERSION),null)
    $(error No version found)
endif

DEB_HOST_ARCH               := $(DEB_TARGET_ARCH)
DPKG_COREDNS_DISTRIBUTION   := $(shell lsb_release -sr)
PACKAGEVERSION              := $(DPKG_COREDNS_VERSION)-0~$(DPKG_COREDNS_DISTRIBUTION)0
TARBALL                     := coredns_$(DPKG_COREDNS_VERSION)_linux_$(DEB_TARGET_ARCH).tgz
# Removed VTARBALL logic as we are not using manpages or other files from source
# VTARBALL                    := v$(DPKG_COREDNS_VERSION).tar.gz

# Debian calls it armhf, we call it arm.
ifeq ($(DEB_TARGET_ARCH),armhf)
    TARBALL := coredns_$(DPKG_COREDNS_VERSION)_linux_arm.tgz
endif

URL := https://github.com/coredns/coredns/releases/download/v$(DPKG_COREDNS_VERSION)/$(TARBALL)

%:
	dh $@ --with systemd

override_dh_strip:
	# don't perform dh_strip
	echo dh_strip

override_dh_auto_clean:
	dh_clean
	rm -f $(TARBALL)

override_dh_auto_test:

override_dh_auto_build:

override_dh_auto_install:
	if [ ! -e $(TARBALL) ]; then curl -L $(URL) -o $(TARBALL); fi

	# Prepare install directories
	mkdir -p debian/coredns11/opt/coredns/bin
	mkdir -p debian/coredns11/opt/coredns/etc
	mkdir -p debian/coredns11/lib/systemd/system

	# Install binary
	tar -xf $(TARBALL) -C debian/coredns11/opt/coredns/bin

	# Install config
	# Finding needed components in peer directory coredns
	cp ../coredns/Corefile debian/coredns11/opt/coredns/etc/Corefile

	# Install systemd unit
	cp systemd/coredns11.service debian/coredns11/lib/systemd/system/

override_dh_gencontrol:
	dh_gencontrol -- -v$(PACKAGEVERSION)
